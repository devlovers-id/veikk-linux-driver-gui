#include "veikkconfig.h"
#include "ui_main.h"
#include "qpressurecurvescene.h"
#include "qscreenmapscene.h"

// set up widgets
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow{parent}, ui{new Ui::MainWindow} {
    qint8 i;

    // basic ui setup (auto-generated by qt designer)
    ui->setupUi(this);

    tabWidget = findChild<QTabWidget *>("tab_widget");
    connect(tabWidget, SIGNAL(currentChanged(int)),
            this, SLOT(tabChanged(int)));

    pressureCurveView = findChild<QGraphicsView *>("pressure_curve_view");
    pressureCurveView->setScene(new QPressureCurveScene{});
    pressureCurveView->scale(1, -1);
    connect(pressureCurveView->scene(), SIGNAL(updatePressureForm(qint16 *)),
            this, SLOT(updatePressureForm(qint16 *)));
    connect(this, SIGNAL(updatePressureCurve(qint16 *)),
            pressureCurveView->scene(), SLOT(updatePressureCurve(qint16 *)));

    screenMapView = findChild<QGraphicsView *>("screen_map_view");
    screenMapView->setScene(new QScreenMapScene{});

    for(i=0; i<4; i++) {
        pressureCoefSpinboxes[i] = findChild<QDoubleSpinBox *>
                                    ("pressure_coef_a" + QString::number(i));
        connect(pressureCoefSpinboxes[i], SIGNAL(valueChanged(double)),
                this, SLOT(updatePressureCoefs()));
    }
}

MainWindow::~MainWindow() {
    delete ui;
}

// resize elements on startup, see: https://stackoverflow.com/questions/9858971
void MainWindow::showEvent(QShowEvent *evt) {
    pressureCurveView->fitInView(pressureCurveView->sceneRect());
    screenMapView->fitInView(screenMapView->sceneRect(), Qt::KeepAspectRatio);
    QWidget::showEvent(evt);
}

void MainWindow::resizeEvent(QResizeEvent *evt) {
    screenMapView->fitInView(screenMapView->sceneRect(), Qt::KeepAspectRatio);
    QWidget::resizeEvent(evt);
}

void MainWindow::tabChanged(int curTab) {
    switch(curTab) {
    case 0: // screen map
        screenMapView->fitInView(screenMapView->sceneRect(),
                                 Qt::KeepAspectRatio);
        break;
    case 1: // pressure map
        pressureCurveView->fitInView(pressureCurveView->sceneRect());
        break;
    }
}

void MainWindow::updatePressureForm(qint16 *newCoefs) {
    qint8 i;
    for(i=0; i<4; i++) {
        pressureCoefSpinboxes[i]->blockSignals(true);
        pressureCoefSpinboxes[i]->setValue(newCoefs[i]/100.0);
        pressureCoefSpinboxes[i]->blockSignals(false);
    }
}

void MainWindow::updatePressureCoefs() {
    qint8 i;
    qint16 newCoefs[4];
    for(i=0; i<4; i++)
        newCoefs[i] = qint16(pressureCoefSpinboxes[i]->value()*100);
    emit updatePressureCurve(newCoefs);
}
